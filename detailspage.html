<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Review Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* Meta info style */
    #review-meta {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
      font-size: 0.95rem;
      color: #6c757d;
    }

    #review-meta span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #review-meta i {
      cursor: pointer;
      color: #0d6efd;
    }
  </style>
</head>
<body>
<div class="site-wrapper">
  <div id="header-container"></div>
  <br>
  <div class="container my-5" style="min-height: 80vh;">
    <!-- Toast container -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="d-flex flex-column justify-content-center align-items-center" style="min-height: 200px;">
      <div class="spinner-border spinner-border-sm text-primary" role="status" style="width: 1.5rem; height: 1.5rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted small">Loading, please wait...</p>
    </div>

    <!-- Review Card -->
    <div id="review-card" class="card shadow-sm mb-4 d-none">
      <div class="card-body">
        <h3 id="review-title" class="fw-bold text-primary"></h3>
        <p id="review-meta" class="text-muted small mb-3"></p>
        <div id="review-content" class="mb-3"></div>
      </div>
    </div>

    <!-- More to see -->
    <div id="more-card" class="card shadow-sm d-none">
      <div class="card-header bg-warning text-dark fw-semibold">
        <i class="bi bi-list-stars me-1"></i> More to See
      </div>
      <ul id="more-reviews" class="list-group list-group-flush"></ul>
    </div>
  </div>

  <div class="footer-container"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_4rFTGZn-I7xYwS9SQIhI4KM7P0I2msE",
    authDomain: "rdm11-34fb1.firebaseapp.com",
    projectId: "rdm11-34fb1",
    storageBucket: "rdm11-34fb1.firebasestorage.app",
    messagingSenderId: "46810528643",
    appId: "1:46810528643:web:406a9ebee9c8a5762954b6",
    measurementId: "G-MP86EYWQE0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  function formatDate(timestamp) {
    if (!timestamp || !timestamp.toDate) return "";
    const d = timestamp.toDate();
    return d.toLocaleDateString() + " " + d.toLocaleTimeString();
  }

  function getTypeIcon(type) {
    switch(type?.toLowerCase()) {
      case 'movie': return '<i class="bi bi-film me-2 text-warning"></i>';
      case 'game': return '<i class="bi bi-controller me-2 text-success"></i>';
      case 'book': return '<i class="bi bi-book me-2 text-info"></i>';
      case 'music': return '<i class="bi bi-music-note me-2 text-danger"></i>';
      default: return '<i class="bi bi-star-fill me-2 text-primary"></i>';
    }
  }

  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
  }

  window.copyLink = url => navigator.clipboard.writeText(url).then(() => showToast('Link copied!'));
  window.shareLink = (url, title='') => {
    if(navigator.share) navigator.share({ title, url }).then(() => showToast(`Shared: ${title}`));
    else showToast('Sharing not supported, copy link instead', 'warning');
  };

  async function loadReviewDetail(id, type) {
    const docRef = doc(db, "Predictions", id);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      document.getElementById("review-title").textContent = "Review not found.";
      return;
    }

    const data = docSnap.data();
    const title = data.title || data.movieTitle || "Untitled";
    const createdBy = data.createdBy || "Yalla Ramana";
    const createdDate = formatDate(data.createddate);
    const pageUrl = window.location.href;

    document.getElementById("review-title").innerHTML = getTypeIcon(type) + title;

    // Updated meta section: labels + icons only for share/copy
    document.getElementById("review-meta").innerHTML = `
      <span><strong>Created by:</strong> ${createdBy}</span>
      <span><strong>Created on:</strong> ${createdDate}</span>
      <span><i class="bi bi-share-fill" onclick="shareLink('${pageUrl}', '${title}')"></i> Share</span>
      <span><i class="bi bi-clipboard" onclick="copyLink('${pageUrl}')"></i> Copy Link</span>
    `;

    document.getElementById("review-content").innerHTML = data.content || "";
  }

  async function loadMoreReviews(currentId, currentType) {
    const moreContainer = document.getElementById("more-reviews");
    moreContainer.innerHTML = '';
    const q = query(collection(db, "Predictions"), orderBy("createddate", "desc"));
    const snapshot = await getDocs(q);

    let hasOther = false;
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const reviewType = data.type || '';
      const title = data.title || data.movieTitle || "Untitled";

      if (docSnap.id === currentId || reviewType.toLowerCase() !== currentType.toLowerCase()) return;

      hasOther = true;
      const reviewLink = `${window.location.origin}/detailspage.html?matchid=${encodeURIComponent(data.matchid || docSnap.id)}&id=${encodeURIComponent(docSnap.id)}&type=${encodeURIComponent(reviewType)}`;

      moreContainer.innerHTML += `
        <li class="list-group-item">
          <i class="bi bi-file-earmark-text me-2 text-warning"></i>
          <a href="${reviewLink}" class="text-decoration-none text-primary">${title}</a>
        </li>`;
    });

    if (!hasOther) {
      moreContainer.innerHTML = `<li class="list-group-item text-center text-muted">No other reviews of this type found.</li>`;
    }
  }

  (async () => {
    const id = getParam("id");
    const type = getParam("type");
    const matchid = getParam("matchid");

    if (!id || !type) {
      document.getElementById("review-title").textContent = "Invalid review parameters.";
      return;
    }

    document.getElementById("loading-spinner").classList.remove("d-none");
    await loadReviewDetail(id, type);
    await loadMoreReviews(id, type);
    document.getElementById("loading-spinner").classList.add("d-none");
    document.getElementById("review-card").classList.remove("d-none");
    document.getElementById("more-card").classList.remove("d-none");
  })();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="header.js"></script>
<script src="footer.js"></script>
</body>
</html>
